<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="logo.png">
    <title>Smile Scada</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f2f2f7; margin: 0; padding: 10px; display: none; /* Ẩn trước khi nhập pass */ }
        h2 { text-align: center; color: #0056b3; margin: 10px 0 5px 0; }
        #status { text-align: center; font-size: 12px; color: #f39c12; margin-bottom: 15px; }
        .card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .header { display: flex; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 10px; }
        .dot { width: 12px; height: 12px; background: #ccc; border-radius: 50%; margin-right: 10px; }
        .dot.active { background: #34c759; box-shadow: 0 0 8px #34c759; }
        .title { font-weight: bold; font-size: 18px; color: #333; }
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 16px; }
        .label { color: #666; }
        .val { font-weight: bold; color: #222; }
        .unit { font-size: 12px; color: #999; }
    </style>
</head>
<body>

    <!-- GIAO DIỆN CHÍNH -->
    <h2>SMILE SCADA</h2>
    <div id="status">Đang kết nối Cloud...</div>

    <!-- TỔ MÁY H1 -->
    <div class="card">
        <div class="header"><div id="led1" class="dot"></div><div class="title">TỔ MÁY H1</div></div>
        <div class="row"><span class="label">P</span> <span><span id="p1" class="val">--</span> <span class="unit">MW</span></span></div>
        <div class="row"><span class="label">Q</span> <span><span id="q1" class="val">--</span> <span class="unit">MVar</span></span></div>
        <div class="row"><span class="label">U</span> <span><span id="u1" class="val">--</span> <span class="unit">kV</span></span></div>
        <div class="row"><span class="label">I</span> <span><span id="i1" class="val">--</span> <span class="unit">A</span></span></div>
    </div>

    <!-- TỔ MÁY H2 -->
    <div class="card">
        <div class="header"><div id="led2" class="dot"></div><div class="title">TỔ MÁY H2</div></div>
        <div class="row"><span class="label">P</span> <span><span id="p2" class="val">--</span> <span class="unit">MW</span></span></div>
        <div class="row"><span class="label">Q</span> <span><span id="q2" class="val">--</span> <span class="unit">MVar</span></span></div>
        <div class="row"><span class="label">U</span> <span><span id="u2" class="val">--</span> <span class="unit">kV</span></span></div>
        <div class="row"><span class="label">I</span> <span><span id="i2" class="val">--</span> <span class="unit">A</span></span></div>
    </div>

    <!-- TỔ MÁY H3 -->
    <div class="card">
        <div class="header"><div id="led3" class="dot"></div><div class="title">TỔ MÁY H3</div></div>
        <div class="row"><span class="label">P</span> <span><span id="p3" class="val">--</span> <span class="unit">MW</span></span></div>
        <div class="row"><span class="label">Q</span> <span><span id="q3" class="val">--</span> <span class="unit">MVar</span></span></div>
        <div class="row"><span class="label">U</span> <span><span id="u3" class="val">--</span> <span class="unit">kV</span></span></div>
        <div class="row"><span class="label">I</span> <span><span id="i3" class="val">--</span> <span class="unit">A</span></span></div>
    </div>

    <!-- THỦY VĂN -->
    <div class="card">
        <div class="header"><div class="title" style="color:#007AFF">THỦY VĂN</div></div>
        <div class="row"><span class="label">Thượng lưu</span> <span><span id="up" class="val">--</span> <span class="unit">m</span></span></div>
        <div class="row"><span class="label">Hạ lưu</span> <span><span id="down" class="val">--</span> <span class="unit">m</span></span></div>
    </div>

    <script>
        // --- CẤU HÌNH MẬT KHẨU ---
        const PASSWORD = "@smile"; // Đặt mật khẩu tại đây

        // Kiểm tra mật khẩu (Lưu vào LocalStorage để không phải nhập lại lần sau)
        const savedPass = localStorage.getItem("scada_pass");
        if (savedPass === PASSWORD) {
            document.body.style.display = "block";
            startMqtt();
        } else {
            const input = prompt("Nhập mật khẩu truy cập:");
            if (input === PASSWORD) {
                localStorage.setItem("scada_pass", PASSWORD);
                document.body.style.display = "block";
                startMqtt();
            } else {
                alert("Sai mật khẩu!");
                window.location.reload(); // Load lại để hỏi tiếp
            }
        }

        function startMqtt() {
            const client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');

            client.on('connect', () => {
                document.getElementById('status').innerText = "● Trực tuyến";
                document.getElementById('status').style.color = "green";
                client.subscribe('H1dataAnalog');
                client.subscribe('H2dataAnalog');
                client.subscribe('H3dataAnalog');
                client.subscribe('TailgatedataAnalog');
            });

            client.on('message', (topic, message) => {
                const parts = message.toString().split(',');
                const getVal = (i, s) => {
                    if (i >= parts.length) return 0;
                    let v = parseFloat(parts[i]);
                    if (v > 32767) v -= 65536;
                    return (v / s).toFixed(2);
                };

                // Hàm cập nhật UI cho 1 tổ máy
                const updateUnit = (id) => {
                    const p = getVal(0, 1000);
                    const q = getVal(1, 1000);
                    const u = getVal(10, 100);
                    const i = getVal(5, 1);
                    document.getElementById('p' + id).innerText = p;
                    document.getElementById('q' + id).innerText = q;
                    document.getElementById('u' + id).innerText = u;
                    document.getElementById('i' + id).innerText = i;
                    
                    if (parseFloat(u) > 1.0) document.getElementById('led' + id).classList.add('active');
                    else document.getElementById('led' + id).classList.remove('active');
                };

                if (topic === 'H1dataAnalog') updateUnit('1');
                if (topic === 'H2dataAnalog') updateUnit('2');
                if (topic === 'H3dataAnalog') updateUnit('3');

                if (topic === 'TailgatedataAnalog') {
                    document.getElementById('up').innerText = getVal(10, 100);
                    document.getElementById('down').innerText = getVal(12, 100);
                }
            });
        }
    </script>
</body>
</html>
