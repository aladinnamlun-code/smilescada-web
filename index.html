<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="logo.png">
    <title>Smile Scada Online</title>
    <!-- Thư viện MQTT -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; margin: 0; padding: 15px; -webkit-tap-highlight-color: transparent; }
        h2 { text-align: center; color: #0056b3; margin-bottom: 5px; }
        #status { text-align: center; font-size: 12px; color: #f39c12; margin-bottom: 15px; }
        
        .card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header { display: flex; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; margin-bottom: 10px; }
        .dot { width: 12px; height: 12px; background: #ccc; border-radius: 50%; margin-right: 10px; }
        .dot.active { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
        .title { font-weight: bold; font-size: 18px; color: #333; }
        
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 16px; }
        .label { color: #666; }
        .val { font-weight: bold; color: #222; }
        .unit { font-size: 12px; color: #999; }
    </style>
</head>
<body>

    <h2>SMILE SCADA</h2>
    <div id="status">Đang kết nối Cloud...</div>

    <!-- TỔ MÁY H1 -->
    <div class="card">
        <div class="header">
            <div id="led1" class="dot"></div>
            <div class="title">TỔ MÁY H1</div>
        </div>
        <div class="row"><span class="label">Công suất P</span> <span><span id="p1" class="val">--</span> <span class="unit">MW</span></span></div>
        <div class="row"><span class="label">Công suất Q</span> <span><span id="q1" class="val">--</span> <span class="unit">MVar</span></span></div>
        <div class="row"><span class="label">Điện áp U</span> <span><span id="u1" class="val">--</span> <span class="unit">kV</span></span></div>
        <div class="row"><span class="label">Dòng điện I</span> <span><span id="i1" class="val">--</span> <span class="unit">A</span></span></div>
    </div>

    <!-- THỦY VĂN -->
    <div class="card">
        <div class="header">
            <div class="title" style="color:#007AFF">THỦY VĂN</div>
        </div>
        <div class="row"><span class="label">Thượng lưu</span> <span><span id="up" class="val">--</span> <span class="unit">m</span></span></div>
        <div class="row"><span class="label">Hạ lưu</span> <span><span id="down" class="val">--</span> <span class="unit">m</span></span></div>
    </div>

    <script>
        // KẾT NỐI EMQX.IO QUA WEBSOCKET (WSS - Cổng 8084)
        // Lưu ý: Cổng 8083 là ws (không bảo mật), 8084 là wss (bảo mật SSL - khuyên dùng)
        const client = mqtt.connect('wss://broker.emqx.io:8084/mqtt')

        client.on('connect', () => {
            console.log('Connected to EMQX')
            document.getElementById('status').innerText = "● Đã kết nối trực tuyến"
            document.getElementById('status').style.color = "green"
            
            // Đăng ký nhận tin
            client.subscribe('H1dataAnalog')
            client.subscribe('TailgatedataAnalog')
        })

        client.on('message', (topic, message) => {
            const parts = message.toString().split(',')
            
            // Hàm xử lý số liệu (Giống logic C#)
            const getVal = (idx, scale) => {
                if (idx >= parts.length) return 0
                let v = parseFloat(parts[idx])
                if (v > 32767) v -= 65536 // Xử lý số âm
                return (v / scale).toFixed(2)
            }

            if (topic === 'H1dataAnalog') {
                const p = getVal(0, 1000)
                const q = getVal(1, 1000)
                const u = getVal(10, 100)
                const i = getVal(5, 1)

                document.getElementById('p1').innerText = p
                document.getElementById('q1').innerText = q
                document.getElementById('u1').innerText = u
                document.getElementById('i1').innerText = i

                // Logic đèn báo trạng thái (U > 1kV)
                if (parseFloat(u) > 1.0) document.getElementById('led1').classList.add('active')
                else document.getElementById('led1').classList.remove('active')
            }

            if (topic === 'TailgatedataAnalog') {
                document.getElementById('up').innerText = getVal(10, 100)
                document.getElementById('down').innerText = getVal(12, 100)
            }
        })
    </script>
</body>
</html>